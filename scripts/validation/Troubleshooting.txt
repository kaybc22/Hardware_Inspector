#nvcc cuda_check.cu -o cuda_check
#CUDA_VISIBLE_DEVICES=0,2,3,4,5,6,7 ./cuda_check
#sudo nvidia-smi -q -i 1 1 -c  -d 

#systemctl stop *nvidia* #sudo rmmod nvidia_uvm nvidia_drm nvidia_modeset nvidia
#echo 1 | sudo tee /sys/bus/pci/devices/0000\:1a\:00.0/remove

#echo 1 | sudo tee /sys/bus/pci/rescan

SpeedChange
	#Link status
	lsts=$(setpci -s $BDF CAP_EXP+I2.W)
	#setting the target speed
	setpci -s $BDF CAP_EXP+III0.L=$speed:0xf
	setpci -s $BDF CAP_EXP+I0.W=II0:II0
	# Set reset bit
	setpci -s $BDF 0x3E.W=IV0:IV0
	sleep 0.1
	# Clear reset bit
	setpci -s $BDF 0x3E.W=0:IV0

SBR
	# Added 0.8 sec delay
	sleep 0.8
	# Set reset bit
	setpci -s $BDF 0x3E.W=IV0:IV0
	#sleep 0.1
	# Clear reset bit
	setpci -s $BDF 0x3E.W=0:IV0
	#sleep 1

LinkDisEna
	#Disable
	setpci -s $BDF CAP_EXP+I0.W=I0:I0 
	sleep 0.1

	#Enable
	setpci -s $BDF CAP_EXP+I0.W=0:I0
	#sleep 0.7

retrain
setpci -s $BDF CAP_EXP+I0.W=II0:II0

#include <iostream>
#include <cuda_runtime.h>
int main() {
   int deviceCount = 0;
   cudaError_t err = cudaGetDeviceCount(&deviceCount);
   if (err != cudaSuccess) {
       std::cerr << "cudaGetDeviceCount failed: "
<< cudaGetErrorString(err) << std::endl;
       return 1;
   }
   std::cout << "Detected " << deviceCount << " CUDA device(s)\n";
   for (int i = 0; i < deviceCount; i++) {
       std::cout << "\nChecking GPU " << i << "...\n";
       // Try to set the device
       err = cudaSetDevice(i);
       if (err != cudaSuccess) {
           std::cerr << "  Failed to set device " << i << ": "
<< cudaGetErrorString(err) << std::endl;
           continue;
       }
       // Query device properties
       cudaDeviceProp prop;
       err = cudaGetDeviceProperties(&prop, i);
       if (err != cudaSuccess) {
           std::cerr << "  Failed to get properties: "
<< cudaGetErrorString(err) << std::endl;
           continue;
       }
       std::cout << "  Name: " << prop.name
<< " | Global Mem: " << (prop.totalGlobalMem >> 20) << " MB"
<< " | SMs: " << prop.multiProcessorCount << std::endl;
       // Test a small allocation
       void* d_ptr = nullptr;
       err = cudaMalloc(&d_ptr, 1024);
       if (err != cudaSuccess) {
           std::cerr << "  cudaMalloc failed: "
<< cudaGetErrorString(err) << std::endl;
       } else {
           std::cout << "  cudaMalloc test OK\n";
           cudaFree(d_ptr);
       }
   }
   return 0;
}

